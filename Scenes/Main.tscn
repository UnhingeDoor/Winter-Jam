[gd_scene load_steps=10 format=3 uid="uid://rrl6e6temvop"]

[ext_resource type="PackedScene" uid="uid://cuxdvqwiaaatv" path="res://Scenes/Present.tscn" id="1_mb113"]
[ext_resource type="PackedScene" uid="uid://1x65lccosvku" path="res://Scenes/Player.tscn" id="2_uywyi"]
[ext_resource type="Script" path="res://Scripts/player_camera.gd" id="3_y4i8p"]
[ext_resource type="PackedScene" uid="uid://s4oqqr201p7v" path="res://Scenes/user_interface.tscn" id="4_nljwa"]
[ext_resource type="PackedScene" uid="uid://cu0vb5uk0orc6" path="res://Scenes/conveyor_belt.tscn" id="5_dcnt0"]
[ext_resource type="PackedScene" uid="uid://cxcjkap0q7536" path="res://Models/SM_Room.glb" id="6_qd2yy"]
[ext_resource type="PackedScene" path="res://Scenes/control_panel.tscn" id="7_k4e4r"]
[ext_resource type="PackedScene" uid="uid://cnagdoi6p82mc" path="res://Models/Buttons table.glb" id="8_51u61"]

[sub_resource type="GDScript" id="GDScript_ud5np"]
script/source = "extends Node

signal present_despawned

@export var max_present_on_screen_count: int = 2
@export var present_scene: PackedScene
@export var default_present_spawn_pos = Vector3(-10, 1.37, 0)

@onready var present_spawn_pos = default_present_spawn_pos


func _ready():
	reset_global_variables()


func _process(_delta):
	# Restart Scene
	if Input.is_key_pressed(KEY_ENTER):
		get_tree().reload_current_scene()
	
	# Control present spawning
	if GlobalVariables.present_on_screen_count < max_present_on_screen_count:
		var present = present_scene.instantiate()
		# Offset the presents' spawning position
		present_spawn_pos.x = default_present_spawn_pos.x - (10 * GlobalVariables.present_on_screen_count)
		present.initialise(present_spawn_pos)
		instantiate_object(present)
		GlobalVariables.present_on_screen_count += 1


func instantiate_object(present):
	add_child(present, true)


func reset_global_variables():
	GlobalVariables.inspection_in_progress = false
	GlobalVariables.present_on_screen_count = 1


func _on_level_timer_timeout():
	get_tree().reload_current_scene()
"

[node name="Main" type="Node"]
script = SubResource("GDScript_ud5np")
present_scene = ExtResource("1_mb113")

[node name="Player" parent="." instance=ExtResource("2_uywyi")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 3.08355)

[node name="PlayerCamera" type="Camera3D" parent="Player"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.876717, 0)
current = true
script = ExtResource("3_y4i8p")

[node name="Present" parent="." instance=ExtResource("1_mb113")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -10, 1.37, 0)

[node name="UserInterface" parent="." instance=ExtResource("4_nljwa")]

[node name="LevelTimer" type="Timer" parent="."]
wait_time = 60.0
one_shot = true
autostart = true

[node name="Conveyor belt" parent="." instance=ExtResource("5_dcnt0")]
transform = Transform3D(-1, 0, -8.74228e-08, 0, 1, 0, 8.74228e-08, 0, -1, 0, 0, -1.32356)

[node name="SM_Room2" parent="." instance=ExtResource("6_qd2yy")]
transform = Transform3D(-1, 0, -8.74228e-08, 0, 1, 0, 8.74228e-08, 0, -1, 0, 0, 0)

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 0.302486, 0.953154, 0, -0.953154, 0.302486, 0, 0, 0)

[node name="ControlPanel" parent="." instance=ExtResource("7_k4e4r")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -2.87862, 0.400327, 1.35347)

[node name="Buttons table" parent="." instance=ExtResource("8_51u61")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.0521483, 0, 1.83136)

[connection signal="present_despawned" from="." to="." method="_on_present_despawned"]
[connection signal="inspection_exited" from="Present" to="." method="_on_present_inspection_exited"]
[connection signal="tree_exited" from="Present" to="." method="_on_present_tree_exited"]
[connection signal="timeout" from="LevelTimer" to="." method="_on_level_timer_timeout"]
[connection signal="present_accepted" from="ControlPanel" to="Present" method="_on_control_panel_present_accepted"]
[connection signal="present_recycled" from="ControlPanel" to="Present" method="_on_control_panel_present_recycled"]
[connection signal="present_rejected" from="ControlPanel" to="Present" method="_on_control_panel_present_rejected"]
